# Změny provedené 2025-01-19

## Shrnutí
Provedena kontrola a oprava backend modulů pro Jervis projekt. Hlavní problémy:
1. Chybějící importy v orchestrator modulech
2. Health check selhání u A2A služeb kvůli špatnému pořadí inicializace

## 1. Build Opravy

### Problém
Build selhal s chybami:
```
e: Unresolved reference 'name' in model.provider.name.uppercase()
```

### Řešení
**Soubory upraveny:**
- `backend/server/src/main/kotlin/com/jervis/orchestrator/OrchestratorAgent.kt:32`
- `backend/server/src/main/kotlin/com/jervis/orchestrator/agents/ContextAgent.kt:14`
- `backend/server/src/main/kotlin/com/jervis/orchestrator/agents/SolutionArchitectAgent.kt:10`

**Změny:**
1. Přidán import: `import ai.koog.prompt.llm.LLModel`
2. Změněno `model.provider.name.uppercase()` → `"OLLAMA"` (hardcoded, protože všechny modely používají Ollama)

**Výsledek:** ✅ Build úspěšný

## 2. A2A Health Check Oprava

### Problém
A2A služby (aider, coding-engine, junie) restartovaly kvůli:
```
Startup probe failed: Get "http://...:3101/health": dial tcp ...: connect: connection refused
```

**Příčina:** Health server se nespouštěl, protože jeho inicializace byla až PO `runBlocking {}`, který blokoval main thread.

### Řešení
**Soubory upraveny:**
- `backend/service-aider/src/main/kotlin/com/jervis/aider/a2a/AiderA2AServer.kt`
- `backend/service-coding-engine/src/main/kotlin/com/jervis/coding/a2a/CodingEngineA2AServer.kt`
- `backend/service-junie/src/main/kotlin/com/jervis/junie/a2a/JunieA2AServer.kt`

**Změna:** Health server se nyní spouští JAKO PRVNÍ na začátku `main()` funkce:

```kotlin
fun main(args: Array<String>) {
    val port = System.getenv("SERVER_PORT")?.toIntOrNull() ?: 3100
    val healthPort = port + 1

    // Start health server FIRST to ensure K8s probes work even if main app fails
    logger.info { "Starting health check server on port $healthPort..." }
    embeddedServer(Netty, port = healthPort, host = "0.0.0.0") {
        routing {
            get("/health") {
                call.respondText("""{"status":"UP"}""", ContentType.Application.Json)
            }
            get("/actuator/health") {
                call.respondText("""{"status":"UP"}""", ContentType.Application.Json)
            }
        }
    }.start(wait = false)
    logger.info { "Health check server started on port $healthPort" }

    // ... zbytek inicializace A2A serveru
}
```

**Výsledek:** Health endpoint je nyní dostupný ihned po startu aplikace.

## 3. Konfigurace Kontrola

### A2A vs HTTP REST Služby

**A2A Služby (WebSocket/JSON-RPC přes Koog):**
- `jervis-aider`: 3100 (a2a), 3101 (health)
- `jervis-coding-engine`: 3200 (a2a), 3201 (health)
- `jervis-junie`: 3300 (a2a), 3301 (health)

**HTTP REST Služby (Ktor HTTP klient):**
- `jervis-tika`: 8081
- `jervis-joern`: 8082
- `jervis-whisper`: 8083
- `jervis-atlassian`: 8084

**ConfigMap (`k8s/configmap.yaml`) je správná:**
```yaml
endpoints:
  aider:
    baseUrl: http://jervis-aider:3100/      # A2A
  coding:
    baseUrl: http://jervis-coding-engine:3200/  # A2A
  junie:
    baseUrl: http://jervis-junie:3300/      # A2A
  tika:
    baseUrl: http://jervis-tika:8081/       # HTTP
  joern:
    baseUrl: http://jervis-joern:8082/      # HTTP
  whisper:
    baseUrl: http://jervis-whisper:8083/    # HTTP
  atlassian:
    baseUrl: http://jervis-atlassian:8084/  # HTTP
```

## 4. Nasazení

### Build Skript Vytvořen
`scripts/build_fixed_services.sh` - automatizuje:
1. Gradle build všech upravených modulů
2. Docker buildx build + push do registry
3. kubectl rollout restart pro všechny deployments

### Manuální Nasazení (pokud skript nefunguje)

```bash
# 1. Build JARs
./gradlew :backend:server:build \
          :backend:service-aider:build \
          :backend:service-coding-engine:build \
          :backend:service-junie:build \
          --parallel

# 2. Build a push Docker images
docker buildx build --platform linux/amd64 \
  -f backend/server/Dockerfile \
  -t registry.damek-soft.eu/jandamek/jervis-server:latest \
  --push .

docker buildx build --platform linux/amd64 \
  -f backend/service-aider/Dockerfile \
  -t registry.damek-soft.eu/jandamek/jervis-aider:latest \
  --push .

docker buildx build --platform linux/amd64 \
  -f backend/service-coding-engine/Dockerfile \
  -t registry.damek-soft.eu/jandamek/jervis-coding-engine:latest \
  --push .

docker buildx build --platform linux/amd64 \
  -f backend/service-junie/Dockerfile \
  -t registry.damek-soft.eu/jandamek/jervis-junie:latest \
  --push .

# 3. Restart deploymentů
kubectl rollout restart deployment jervis-server -n jervis
kubectl rollout restart deployment jervis-aider -n jervis
kubectl rollout restart deployment jervis-coding-engine -n jervis
kubectl rollout restart deployment jervis-junie -n jervis

# 4. Sledování stavu
kubectl get pods -n jervis -w
```

### Verifikace
```bash
# Kontrola logů
kubectl logs -n jervis -l app=jervis-aider --tail=50 | grep "Health check server started"
kubectl logs -n jervis -l app=jervis-coding-engine --tail=50 | grep "Health check server started"
kubectl logs -n jervis -l app=jervis-junie --tail=50 | grep "Health check server started"

# Kontrola health endpointu
kubectl exec -n jervis deployment/jervis-aider -- curl -s http://localhost:3101/health
kubectl exec -n jervis deployment/jervis-coding-engine -- curl -s http://localhost:3201/health
kubectl exec -n jervis deployment/jervis-junie -- curl -s http://localhost:3301/health
```

## Soubory Změněny

1. `backend/server/src/main/kotlin/com/jervis/orchestrator/OrchestratorAgent.kt`
2. `backend/server/src/main/kotlin/com/jervis/orchestrator/agents/ContextAgent.kt`
3. `backend/server/src/main/kotlin/com/jervis/orchestrator/agents/SolutionArchitectAgent.kt`
4. `backend/service-aider/src/main/kotlin/com/jervis/aider/a2a/AiderA2AServer.kt`
5. `backend/service-coding-engine/src/main/kotlin/com/jervis/coding/a2a/CodingEngineA2AServer.kt`
6. `backend/service-junie/src/main/kotlin/com/jervis/junie/a2a/JunieA2AServer.kt`

## Nové Soubory

1. `scripts/build_fixed_services.sh` - Automatizační skript pro build a deploy
2. `CHANGES_2025_01_19.md` - Tento soubor

---
*Vygenerováno Claude Code - 2025-01-19*
