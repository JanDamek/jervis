# Logging level configuration
logging:
  level:
    root: INFO
    com.jervis: INFO
    com.jervis.service: INFO
    org.springframework.web: INFO
    org.springframework.web.reactive.socket: INFO
    org.springframework.web.reactive.handler: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${DATA_ROOT_DIR}/logs/jervis-app.log
  logback:
    rollingpolicy:
      max-history: 7
      max-file-size: 10MB

spring:
  data:
    mongodb:
      host: 192.168.100.117
      port: 27017
      database: jervis
      # Uncomment and set these for production with authentication
      username: root
      password: REDACTED_MONGODB_PASSWORD
      authentication-database: admin
      auto-index-creation: true

# Vector database configuration
# Weaviate - hybrid search vector DB with BM25 + semantic search
weaviate:
  enabled: true
  host: 192.168.100.117  # Change to TrueNAS host after deployment
  port: 8080  # HTTP REST API port
  scheme: http
  grpc-port: 50051  # gRPC port for high-performance operations
  hybrid-search:
    enabled: true
    alpha: 0.85  # 0.85 = 85% semantic + 15% keyword (BM25) - optimized for Czech text with BGE-M3
  auto-migrate:
    enabled: true  # Automatically migrate schema when config changes
    countdown-seconds: 10  # Countdown before starting migration (Ctrl+C to abort)
    require-confirmation: false  # Set to true to require manual API confirmation
    dry-run: false  # Set to true to simulate migration without deleting data

server:
  port: 5500
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: changeit
    key-store-type: PKCS12
    key-alias: jervis
  netty:
    connection-timeout: 600s # 10 minutes for long-running agent operations
    idle-timeout: 600s

management:
  endpoints:
    web:
      exposure:
        include: "health"
  endpoint:
    health:
      probes:
        enabled: true

jervis:
  background:
    enabled: true
    wait-on-error: 30s
  security:
    # Unique client token for mobile apps - acts as port scanning protection
    # Any request without this header is considered an attack attempt and gets no response
    client-token: "a7f3c9e2-4b8d-11ef-9a1c-0242ac120002"

  # Adaptive API rate limiting to prevent bans (applied per domain)
  # Phase 1: Fast initial sync, Phase 2: Moderate speed, Phase 3: Conservative sustained rate
  rate-limit:
    phase1-item-count: 100      # First 100 items processed quickly
    phase1-delay-ms: 0           # No delay during fast burst
    phase2-item-count: 400       # Next 400 items (101-500) at moderate speed
    phase2-delay-ms: 100         # 100ms = 10 req/sec
    phase3-delay-ms: 1000        # After 500 items: 1000ms = 1 req/sec (prevents API bans)

# HTTP client connections and timeouts (used by WebClient)
connections:
  connection-pool:
    max-connections: 500
    max-idle-time: 30m
    max-life-time: 60m
    pending-acquire-timeout: 30m
    evict-in-background: 60m
    pending-acquire-max-count: 1000
  timeouts:
    connect-timeout-millis: 60000
    response-timeout-millis: 180000  # 3 minutes for embedding operations

# Retry configuration for external HTTP calls
retry:
  webclient:
    max-attempts: 5
    initial-backoff-millis: 1000
    max-backoff-millis: 30000
    backoff-multiplier: 2.0

# Workspace configuration - central root for all server-managed files
data:
  root-dir: ${DATA_ROOT_DIR}

# Audio processing configuration
audio:
  monitoring:
    default-git-check-interval-minutes: 15
    supported-formats:
      - wav
      - mp3
      - m4a
      - flac
      - ogg
      - opus
      - webm

# Text chunking configuration
text:
  chunking:
    max-tokens: 3072  # Optimized for BGE-M3 (8192 context) - larger chunks preserve more context
    overlap-percentage: 12  # Reduced overlap as chunks are now larger (saves storage & improves diversity)
    chars-per-token: 3.5  # More accurate for Czech/multilingual text (Czech averages ~3.2-3.8 chars/token)

# Link indexing configuration
link:
  indexing:
    skip-if-indexed-within: 30d

# Git synchronization configuration
git:
  sync:
    # Interval for checking and syncing Git repositories (in milliseconds)
    polling-interval-ms: 300000 # 5 minutes
    initial-delay-ms: 60000 # 1 minute after startup
