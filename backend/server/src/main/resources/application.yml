# Logging level configuration
logging:
  level:
    root: INFO
    com.arangodb.internal.serde.SerdeUtils: INFO
    com.jervis: INFO
    com.jervis.service: INFO
    ai.koog: INFO
    com.jervis.koog: INFO
    org.springframework.web: WARN
    org.springframework.web.reactive.socket: WARN
    org.springframework.web.reactive.handler: WARN
    org.springframework.data.mongodb.core.convert.QueryMapper: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${DATA_ROOT_DIR}/logs/jervis-app.log
  logback:
    rollingpolicy:
      max-history: 7
      max-file-size: 10MB

spring:
  mongodb:
    host: 192.168.100.117
    port: 27017
    database: jervis
    # Uncomment and set these for production with authentication
    username: root
    password: REDACTED_MONGODB_PASSWORD
    authentication-database: admin
  data:
    mongodb:
      auto-index-creation: false  # Disabled - indexes managed by MongoIndexInitializer

# Vector database configuration
# Weaviate - hybrid search vector DB with BM25 + semantic search
weaviate:
  enabled: true
  host: 192.168.100.117  # Change to TrueNAS host after deployment
  port: 8080  # HTTP REST API port
  scheme: http
  grpc-port: 50051  # gRPC port for high-performance operations
  hybrid-search:
    enabled: true
    alpha: 0.85  # 0.85 = 85% semantic + 15% keyword (BM25) - optimized for Czech text with BGE-M3
  auto-migrate:
    enabled: true  # Automatically migrate schema when config changes
    countdown-seconds: 10  # Countdown before starting migration (Ctrl+C to abort)
    require-confirmation: false  # Set to true to require manual API confirmation
    dry-run: false  # Set to true to simulate migration without deleting data

server:
  port: 5500
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: changeit
    key-store-type: PKCS12
    key-alias: jervis
  netty:
    connection-timeout: 600s # 10 minutes for long-running agent operations
    idle-timeout: 600s

management:
  endpoints:
    web:
      exposure:
        include: "health"
  endpoint:
    health:
      probes:
        enabled: true

# ArangoDB (Knowledge Graph) configuration
arango:
  scheme: http
  host: 192.168.100.117
  port: 8529
  database: jervis
  username: root
  password: changeit
  timeout-ms: 5000

jervis:
  background:
    wait-on-error: 30s
    wait-interval: 30s
    wait-on-startup: 1m
  koog:
    max-iterations: 900
  polling:
    # Polling intervals for different connection types
    http: 5m    # Jira, Confluence, etc.
    imap: 5m    # IMAP email
    pop3: 5m    # POP3 email
    oauth2: 5m  # OAuth2 connections
    # Note: SMTP is for sending only, not used for polling
  security:
    # Unique client token for mobile apps - acts as port scanning protection
    # Any request without this header is considered an attack attempt and gets no response
    client-token: "a7f3c9e2-4b8d-11ef-9a1c-0242ac120002"

  # Adaptive API rate limiting to prevent bans (applied per domain)
  # Phase 1: Fast initial sync, Phase 2: Moderate speed, Phase 3: Conservative sustained rate
  rate-limit:
    phase1-item-count: 100      # First 100 items processed quickly
    phase1-delay-ms: 0           # No delay during fast burst
    phase2-item-count: 400       # Next 400 items (101-500) at moderate speed
    phase2-delay-ms: 100         # 100ms = 10 req/sec
    phase3-delay-ms: 1000        # After 500 items: 1000ms = 1 req/sec (prevents API bans)

  # Ktor HttpClient configuration (for external HTTP calls)
  http-client:
    max-requests-per-second: 10
    max-requests-per-minute: 100
    rate-limit-enabled: true
    rate-limit-ttl-seconds: 300  # 5 minutes TTL for unused domain rate limiters
    request-timeout-ms: 30000    # 30 seconds
    connect-timeout-ms: 10000    # 10 seconds
    socket-timeout-ms: 30000     # 30 seconds

  # Netty server configuration (embedded Netty for WebFlux)
  netty:
    connect-timeout-ms: 60000    # 60 seconds
    idle-timeout-seconds: 600    # 10 minutes
    read-timeout-seconds: 600    # 10 minutes
    write-timeout-seconds: 600   # 10 minutes
    so-keepalive: true

# HTTP client connections and timeouts (WebClient for external compute services with @HttpExchange: joern, tika, whisper)
connections:
  connection-pool:
    max-connections: 500
    max-idle-time: 30m
    max-life-time: 60m
    pending-acquire-timeout: 30m
    evict-in-background: 60m
    pending-acquire-max-count: 1000
  timeouts:
    connect-timeout-millis: 60000
    response-timeout-millis: 1800000  # 30 minutes for reasoning models (Qwen3, DeepSeek, etc.)
  buffers:
    default-max-in-memory-bytes: 8388608      # 8 MB (default for most endpoints)
    tika-max-in-memory-bytes: 67108864        # 64 MB (for large Tika document payloads)

# Ktor HTTP client for LLM providers (OpenAI, Anthropic, Google, Ollama, LM Studio) and HTTP services (searxng)
ktor:
  connection-pool:
    max-connections: 500
    max-connections-per-route: 100
    keep-alive-time-millis: 300000  # 5 minutes
  timeouts:
    connect-timeout-millis: 60000
    request-timeout-millis: 1800000  # 30 minutes for reasoning models (Qwen3, DeepSeek, etc.)
    socket-timeout-millis: 1800000   # 30 minutes
  api-versions:
    anthropic-version: "2023-06-01"
  logging:
    enabled: false
    level: "INFO"

# Retry configuration for external HTTP calls
retry:
  webclient:
    max-attempts: 5
    initial-backoff-millis: 1000
    max-backoff-millis: 30000
    backoff-multiplier: 2.0
  ktor:
    max-attempts: 5
    initial-backoff-millis: 1000
    max-backoff-millis: 30000

# Workspace configuration - central root for all server-managed files
data:
  root-dir: ${DATA_ROOT_DIR}

# Link indexing configuration
link:
  indexing:
    skip-if-indexed-within: 30d

# Ollama preload and keep-alive configuration (fail-fast: all values must be provided)
preload:
  ollama:
    gpu:
      concurrency: 2
    cpu:
      concurrency: 6
    llm:
      keep-alive: 1h
      refresh-safety-factor: 0.9
    embed:
      concurrency: 6
      keep-alive: 1h
      refresh-safety-factor: 0.9

coding-tools:
  aider:
    default-provider: ollama
    default-model: qwen3-coder-tool:30b
    paid-provider: anthropic
    paid-model: claude-3-5-sonnet-20241022
  openhands:
    default-provider: ollama
    default-model: qqwen3-coder-tool:30b
    paid-provider: anthropic
    paid-model: claude-3-5-sonnet-20241022
    ollama-base-url: http://192.168.100.117:11434

endpoints:
  searxng:
    baseUrl: ${SEARXNG_BASE_URL:http://192.168.100.117:30053/}
  openhands:
    baseUrl: ${OPENHANDS_BASE_URL:http://192.168.100.117:3000/}
  joern:
    baseUrl: ${JOERN_BASE_URL:http://192.168.100.117:8082/}
  tika:
    baseUrl: ${TIKA_BASE_URL:http://192.168.100.117:8081/}
  whisper:
    baseUrl: ${WHISPER_BASE_URL:http://192.168.100.117:8083/}
  atlassian:
    #    baseUrl: ${ATLASSIAN_BASE_URL:http://192.168.100.117:8084/}
    baseUrl: ${ATLASSIAN_BASE_URL:http://localhost:8084/}
  aider:
    #    baseUrl: ${AIDER_BASE_URL:http://192.168.100.117:3100/}
    baseUrl: ${AIDER_BASE_URL:http://localhost:3100/}
  coding:
    #    baseUrl: ${CODING_BASE_URL:http://192.168.100.117:3200/}
    baseUrl: ${CODING_BASE_URL:http://localhost:3200/}
