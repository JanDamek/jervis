---
# =============================================================================
# Jervis Server – Production Configuration (K8s ConfigMap)
# Mounted as /opt/jervis/config/application.yml in the server container.
#
# Differences from local (backend/server/src/main/resources/application.yml):
# - K8s service names instead of localhost (e.g., ws://jervis-tika:8081/)
# - Higher timeouts (30min request/socket vs 11min local)
# - qualifier.max-retries/backoff config (not in local)
# - No data-dir overrides
#
# Ollama endpoints and model routing are in models-config.yaml (not duplicated here).
# See docs/structures.md § "Ollama Instance Architecture" for hardware layout.
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: jervis-server-config
  namespace: jervis
data:
  application.yml: |
    # -- Logging ----------------------------------------------------------------
    logging:
      level:
        root: INFO
        com.jervis: INFO
        io.ktor: INFO
        org.springframework: INFO
        com.arangodb.internal.serde.SerdeUtils: INFO
        com.jervis.qualifier: INFO
        org.springframework.web: WARN
        org.springframework.web.reactive.socket: WARN
        org.springframework.web.reactive.handler: WARN
        org.springframework.data.mongodb.core.convert.QueryMapper: WARN
      pattern:
        console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
        file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
      file:
        name: /opt/jervis/data/logs/jervis-server.log
      logback:
        rollingpolicy:
          max-history: 7
          max-file-size: 10MB

    # -- Spring / MongoDB -------------------------------------------------------
    spring:
      main:
        web-application-type: none   # Non-web (RSocket + custom transport)
      mongodb:
        host: 192.168.100.117
        port: 27017
        database: jervis
        username: root
        password: ${MONGODB_PASSWORD}
        authentication-database: admin
      data:
        mongodb:
          auto-index-creation: false

    # -- Weaviate (vector store for RAG) ----------------------------------------
    weaviate:
      host: 192.168.100.117
      port: 8080                     # REST API
      scheme: http
      grpc-port: 50051               # gRPC for fast vector ops
      hybrid-search:
        enabled: true
        alpha: 0.85                  # 0.85 = vector-heavy hybrid search
      auto-migrate:
        countdown-seconds: 10

    data:
      root-dir: /opt/jervis/data     # Mounted PVC (jervis-data-pvc)

    # -- ArangoDB (knowledge graph) ---------------------------------------------
    arango:
      scheme: http
      host: 192.168.100.117
      port: 8529
      database: jervis
      username: root
      password: ${ARANGO_PASSWORD}
      timeout-ms: 5000

    # -- Jervis core settings ---------------------------------------------------
    jervis:
      security:
        client-token: a7f3c9e2-4b8d-11ef-9a1c-0242ac120002  # RSocket auth token
      qualifier:
        max-retries: 5              # Max retries for qualifier agent per task
        initial-backoff-ms: 1000    # Initial retry delay (1s)
        max-backoff-ms: 300000      # Max retry delay (5min)
      background:
        wait-on-startup: 10s         # Delay before BackgroundEngine starts
        wait-on-error: 1m           # Delay after error before retrying
        wait-interval: 30s           # Qualification loop sleep between cycles
      kb-callback-base-url: "http://jervis-server:5500"  # KB progress push callback URL

    link:
      indexing:
        skip-if-indexed-within: 30d

    # -- Coding tools (Aider, OpenHands, Claude, Junie) ------------------------
    coding-tools:
      aider:
        default-provider: ollama     # GPU instance (:11434)
        default-model: "qwen3-coder-tool:30b"
        paid-provider: anthropic
        paid-model: "claude-3-5-sonnet-20241022"
      openhands:
        default-provider: ollama
        default-model: "qwen3-coder-tool:30b"
        paid-provider: anthropic
        paid-model: "claude-3-5-sonnet-20241022"
        ollama-base-url: http://jervis-ollama-router:11430  # Via Ollama Router
      claude:
        default-provider: anthropic  # Claude Code always uses cloud
        default-model: "claude-sonnet-4-20250514"
        paid-provider: anthropic
        paid-model: "claude-sonnet-4-20250514"
      junie:
        default-provider: anthropic  # Junie coding agent
        default-model: "claude-3-5-sonnet-20241022"
        paid-provider: anthropic
        paid-model: "claude-3-5-sonnet-20241022"

    # -- Microservice endpoints (K8s service names) -----------------------------
    # Ollama endpoints are in models-config.yaml, not here.
    endpoints:
      searxng:
        baseUrl: http://192.168.100.117:30053/       # SearXNG web search (NodePort)
      tika:
        baseUrl: ws://jervis-tika:8081/              # Document extraction
      knowledgebase:
        baseUrl: http://jervis-knowledgebase:8080/        # Python KB (RAG+Graph) - read operations
      knowledgebase-write:
        baseUrl: http://jervis-knowledgebase-write:8080/  # Python KB - write operations (ingest)
      orchestrator:
        baseUrl: http://jervis-orchestrator:8090/    # Python orchestrator (LangGraph)
      correction:
        baseUrl: http://jervis-correction:8000/      # Python correction service (transcript correction)
      providers:
        github: ws://jervis-github:8085/             # GitHub integration
        gitlab: ws://jervis-gitlab:8086/             # GitLab integration
        atlassian: ws://jervis-atlassian:8084/       # Atlassian (Jira/Confluence)


---
# =============================================================================
# Knowledge Base Microservice – Production Configuration (K8s ConfigMap)
# Injected as env vars via envFrom in k8s/app_knowledgebase.yaml.
# Maps to Python Settings class in backend/service-knowledgebase/app/core/config.py.
# See docs/structures.md § "Ollama Instance Architecture" for hardware layout.
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: jervis-knowledgebase-config
  namespace: jervis
data:
  # -- Ollama endpoints (all via Ollama Router on :11430) ---------------------
  OLLAMA_BASE_URL: "http://jervis-ollama-router:11430"             # Via router → GPU/CPU
  OLLAMA_EMBEDDING_BASE_URL: "http://jervis-ollama-router:11430"   # Via router → GPU/CPU
  OLLAMA_INGEST_BASE_URL: "http://jervis-ollama-router:11430"      # Via router → GPU/CPU
  # -- Model routing (see docs/structures.md § "Model Routing") ---------------
  LLM_MODEL: "qwen3-coder-tool:30b"                           # General KB LLM (same as orchestrator → shares GPU)
  INGEST_MODEL_SIMPLE: "qwen2.5:7b"                           # Fast: link relevance check (CPU)
  INGEST_MODEL_COMPLEX: "qwen3-coder-tool:30b"                # Accurate: summary + entity extraction (GPU when CRITICAL)
  # -- Storage backends -------------------------------------------------------
  WEAVIATE_URL: "http://192.168.100.117:8080"                  # Vector store (RAG)
  WEAVIATE_GRPC_URL: "192.168.100.117:50051"                   # Weaviate gRPC
  ARANGO_URL: "http://192.168.100.117:8529"                    # Knowledge graph
  ARANGO_DB: "jervis"
  ARANGO_USER: "root"
  # -- Microservice endpoints -------------------------------------------------
  TIKA_URL: "http://192.168.100.117:8081"                      # Apache Tika
  KOTLIN_SERVER_URL: "http://jervis-server:5500"               # Kotlin server for progress callbacks

---
# =============================================================================
# Orchestrator Microservice – Production Configuration (K8s ConfigMap)
# Injected as env vars via envFrom in k8s/app_orchestrator.yaml.
# Maps to Python Settings class in backend/service-orchestrator/app/config.py.
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: jervis-orchestrator-config
  namespace: jervis
data:
  # -- Service configuration --------------------------------------------------
  ORCHESTRATOR_PORT: "8090"
  K8S_NAMESPACE: "jervis"
  DATA_ROOT: "/opt/jervis/data"
  CONTAINER_REGISTRY: "registry.damek-soft.eu/jandamek"
  # -- Microservice endpoints -------------------------------------------------
  KOTLIN_SERVER_URL: "http://jervis-server:5500"
  KNOWLEDGEBASE_URL: "http://jervis-knowledgebase:8080"
  SEARXNG_URL: "http://192.168.100.117:30053"
  # -- Ollama endpoints (via Ollama Router on :11430) -------------------------
  OLLAMA_API_BASE: "http://jervis-ollama-router:11430"

---
# =============================================================================
# Ollama Router – GPU/CPU routing proxy (K8s ConfigMap)
# Injected as env vars via envFrom in k8s/app_ollama_router.yaml.
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: jervis-ollama-router-config
  namespace: jervis
data:
  ROUTER_PORT: "11430"
  GPU_BACKENDS: '[{"url":"http://192.168.100.117:11434","vram_gb":24,"name":"p40"}]'
  CPU_BACKEND_URL: "http://192.168.100.117:11435"
  ORCHESTRATOR_MODEL: "qwen3-coder-tool:30b"
  ORCHESTRATOR_RESERVATION_TIMEOUT_S: "600"
  ORCHESTRATOR_IDLE_TIMEOUT_S: "60"
  MODEL_LOAD_TIMEOUT_S: "120"
  BACKGROUND_LOAD_DELAY_S: "5"
  DEFAULT_KEEP_ALIVE: "10m"

---
# =============================================================================
# MCP Server – Production Configuration (K8s ConfigMap)
# Injected as env vars via envFrom in k8s/app_mcp.yaml.
# Exposes Jervis platform as MCP tools for Claude Desktop / Claude Code.
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: jervis-mcp-config
  namespace: jervis
data:
  MCP_HOST: "0.0.0.0"
  MCP_PORT: "8100"
  MCP_MONGODB_HOST: "192.168.100.117"
  MCP_MONGODB_PORT: "27017"
  MCP_MONGODB_USER: "root"
  MCP_MONGODB_DATABASE: "jervis"
  # -- Microservice endpoints (K8s service names) --
  MCP_KNOWLEDGEBASE_URL: "http://jervis-knowledgebase:8080"
  MCP_KNOWLEDGEBASE_WRITE_URL: "http://jervis-knowledgebase-write:8080"
  MCP_KOTLIN_SERVER_URL: "http://jervis-server:5500"
  # -- Default tenant (override per tool call) --
  MCP_DEFAULT_CLIENT_ID: ""
  MCP_DEFAULT_PROJECT_ID: ""